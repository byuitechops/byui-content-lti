(function(){tinymce.create("tinymce.plugins.IcePlugin",{deleteTag:"span",insertTag:"span",deleteClass:"del",insertClass:"ins",changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",preserveOnPaste:"p",user:{name:"Unknown User",id:Math.random()},isTracking:true,contentEditable:true,css:"css/ice.css",manualInit:false,scriptVersion:new Date().getTime(),afterInit:function(){},afterClean:function(a){return a},beforePasteClean:function(a){return a},afterPasteClean:function(a){return a},init:function(b,c){var a=this,f=null;b.onPostRender.add(function(h){var i=b.dom;tinymce.extend(a,b.getParam("ice"));a.insertSelector="."+a.insertClass;a.deleteSelector="."+a.deleteClass;b.serializer.addRules(a.insertTag+"[id|class|title|"+a.changeIdAttribute+"|"+a.userIdAttribute+"|"+a.userNameAttribute+"|"+a.timeAttribute+"]");b.serializer.addRules(a.deleteTag+"[id|class|title|"+a.changeIdAttribute+"|"+a.userIdAttribute+"|"+a.userNameAttribute+"|"+a.timeAttribute+"]");b.serializer.addRules("tempdel[data-allocation]");i.loadCSS(a.css.indexOf("://")>0?a.css:(c+"/"+a.css));var j=function(){if(!a.manualInit){b.execCommand("initializeice")}};var g=document.createElement("script");g.type="text/javascript";if(g.readyState){g.onreadystatechange=function(){j()}}else{g.onload=j}g.src=c+"/js/ice.min.js?version="+a.scriptVersion;document.getElementsByTagName("head")[0].appendChild(g);b.controlManager.setActive("ice_toggleshowchanges",true);if(a.isTracking){b.controlManager.setActive("ice_togglechanges",true)}});b.addCommand("initializeice",function(g){b=g||b;tinymce.DOM.win.setTimeout(function(){f=new ice.InlineChangeEditor({element:b.getBody(),isTracking:a.isTracking,contentEditable:a.contentEditable,changeIdAttribute:a.changeIdAttribute,userIdAttribute:a.userIdAttribute,userNameAttribute:a.userNameAttribute,timeAttribute:a.timeAttribute,currentUser:{id:a.user.id,name:a.user.name},plugins:["IceEmdashPlugin","IceAddTitlePlugin","IceSmartQuotesPlugin",{name:"IceCopyPastePlugin",settings:{pasteType:"formattedClean",preserve:a.preserveOnPaste,beforePasteClean:a.beforePasteClean,afterPasteClean:a.afterPasteClean}}],changeTypes:{insertType:{tag:a.insertTag,alias:a.insertClass},deleteType:{tag:a.deleteTag,alias:a.deleteClass}}}).startTracking();b.onEvent.add(function(h,i){return f.handleEvent(i)});setTimeout(function(){a.afterInit.call(a)},10)},500)});b.addCommand("ice_initenv",function(){f.initializeEnvironment();f.initializeRange()});b.addCommand("icecleanbody",function(h){var g=f.getCleanContent(h||b.getContent(),a.afterClean,a.beforeClean);return g});b.addCommand("ice_hasDeletePlaceholders",function(){return f.isPlaceholdingDeletes});b.addCommand("ice_addDeletePlaceholders",function(){return f.placeholdDeletes()});b.addCommand("ice_removeDeletePlaceholders",function(){return f.revertDeletePlaceholders()});b.addCommand("iceinsert",function(g){g=g||{};f.insert(g.item,g.range)});b.addCommand("icedelete",function(g){g=g||{};f.deleteContents(g.right,g.range)});b.addCommand("ice_changeuser",function(g){f.setCurrentUser(g)});b.addCommand("iceaccept",function(g){b.undoManager.add();f.acceptChange(g||b.selection.getNode());d()});b.addCommand("icereject",function(g){b.undoManager.add();f.rejectChange(g||b.selection.getNode());d()});b.addCommand("iceacceptall",function(){b.undoManager.add();f.acceptAll();d()});b.addCommand("icerejectall",function(){b.undoManager.add();f.rejectAll();d()});b.addCommand("ice_toggleshowchanges",function(){var h=b.getBody(),g=b.controlManager,i=true;if(b.dom.hasClass(h,"CT-hide")){g.setActive("ice_toggleshowchanges",true);b.dom.removeClass(h,"CT-hide");i=false}else{g.setActive("ice_toggleshowchanges",false);b.dom.addClass(h,"CT-hide")}tinymce.each(["iceacceptall","icerejectall"],function(j){g.setDisabled(j,i)});b.execCommand("mceRepaint")});b.addCommand("ice_smartquotes",function(g){f.pluginsManager.plugins.IceSmartQuotesPlugin.convert(b.getBody());if(!g){b.windowManager.alert("Regular quotes have been converted into smart quotes.")}});b.addCommand("ice_togglechanges",function(){if(f.isTracking){b.execCommand("ice_disable")}else{b.execCommand("ice_enable")}});b.addCommand("ice_enable",function(){f.enableChangeTracking();b.controlManager.setActive("ice_togglechanges",true);a.isTracking=true});b.addCommand("ice_disable",function(){f.disableChangeTracking();b.controlManager.setActive("ice_togglechanges",false);a.isTracking=false});b.addCommand("ice_isTracking",function(){return f.isTracking?1:0});b.addCommand("ice_strippaste",function(g){return f.pluginsManager.plugins.IceCopyPastePlugin.stripPaste(g)});b.addCommand("ice_handlepaste",function(g){return f.pluginsManager.plugins.IceCopyPastePlugin.handlePaste()});b.addCommand("ice_handleemdash",function(g){return f.pluginsManager.plugins.IceEmdashPlugin.convertEmdash()?1:0});b.addButton("iceaccept",{title:"Accept Change",image:c+"/img/accept.gif",cmd:"iceaccept"});b.addButton("icereject",{title:"Reject Change",image:c+"/img/reject.gif",cmd:"icereject"});b.addButton("iceacceptall",{title:"Accept All Changes",image:c+"/img/ice-accept.png",cmd:"iceacceptall"});b.addButton("icerejectall",{title:"Reject All Changes",image:c+"/img/ice-reject.png",cmd:"icerejectall"});b.addButton("ice_toggleshowchanges",{title:"Show/Hide Track Changes",image:c+"/img/ice-showchanges.png",cmd:"ice_toggleshowchanges"});b.addButton("ice_smartquotes",{title:"Convert quotes to smart quotes","class":"mce_blockquote",cmd:"ice_smartquotes"});b.addButton("ice_togglechanges",{title:"Turn On Track Changes ",image:c+"/img/ice-togglechanges.png",cmd:"ice_togglechanges"});if(b.plugins.contextmenu){b.plugins.contextmenu.onContextMenu.add(function(h,i,g){if(e(g)){i.add({title:"Accept Change",icon:"accept",cmd:"iceaccept"});i.add({title:"Reject Change",icon:"reject",cmd:"icereject"})}})}b.onNodeChange.add(function(h,g,i){if(e(i)){g.setDisabled("iceaccept",false);g.setDisabled("icereject",false)}else{g.setDisabled("iceaccept",true);g.setDisabled("icereject",true)}d()});function e(g){return !!b.dom.getParent(g,a.insertSelector+","+a.deleteSelector)}function d(){var g=b.dom.select(a.insertSelector+":empty,"+a.deleteSelector+":empty");b.dom.remove(g)}}});tinymce.PluginManager.add("ice",tinymce.plugins.IcePlugin)})();